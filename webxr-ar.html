<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR</title>

    <!-- 使用CDN加载非模块版本的Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    
    <!-- 使用非模块版本的加载器和控制器 -->
    <script>
        // GLTFLoader
        THREE.GLTFLoader = function(manager) {
            THREE.Loader.call(this, manager);
            this.dracoLoader = null;
            this.ktx2Loader = null;
            this.meshoptDecoder = null;
            this.pluginCallbacks = [];
            this.register(function(parser) {
                return new GLTFMaterialsClearcoatExtension(parser);
            });
        };

        THREE.GLTFLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {
            constructor: THREE.GLTFLoader,
            load: function(url, onLoad, onProgress, onError) {
                var scope = this;
                var resourcePath;
                if (this.resourcePath !== '') {
                    resourcePath = this.resourcePath;
                } else if (this.path !== '') {
                    resourcePath = this.path;
                } else {
                    resourcePath = THREE.LoaderUtils.extractUrlBase(url);
                }
                scope.manager.itemStart(url);
                var _onError = function(e) {
                    if (onError) {
                        onError(e);
                    } else {
                        console.error(e);
                    }
                    scope.manager.itemError(url);
                    scope.manager.itemEnd(url);
                };
                var loader = new THREE.FileLoader(scope.manager);
                loader.setPath(this.path);
                loader.setResponseType('arraybuffer');
                loader.setRequestHeader(this.requestHeader);
                loader.setWithCredentials(this.withCredentials);
                loader.load(url, function(data) {
                    try {
                        scope.parse(data, resourcePath, function(gltf) {
                            onLoad(gltf);
                            scope.manager.itemEnd(url);
                        }, _onError);
                    } catch (e) {
                        _onError(e);
                    }
                }, onProgress, _onError);
            }
        });
    </script>

    <style>
        body { margin: 0; overflow: hidden; }
        #info {
            position: fixed;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            z-index: 100;
        }
        #startAR {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #startAR:disabled {
            background: #ccc;
        }
    </style>
</head>
<body>
    <div id="info">正在检查 AR 支持...</div>
    <button id="startAR" disabled>启动 AR</button>

    <script>
        class WebXRAR {
            constructor() {
                this.container = document.createElement('div');
                document.body.appendChild(this.container);

                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
                
                // 初始化渲染器
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                this.container.appendChild(this.renderer.domElement);

                // 模型相关
                this.model = null;
                this.modelPath = './data/gcc.glb';
                this.modelScale = 0.1;
                this.mixers = [];
                this.clock = new THREE.Clock();

                // 初始化加载器
                this.loadingManager = new THREE.LoadingManager();
                this.gltfLoader = new THREE.GLTFLoader(this.loadingManager);
                
                // AR 相关
                this.hitTestSource = null;
                this.hitTestSourceRequested = false;
                this.reticle = null;
                this.controller = null;

                // 初始化场景
                this.initScene();
                this.initAR();
                this.setupEventListeners();
                this.setupLoaderEvents();
                this.loadModel();
            }

            setupLoaderEvents() {
                // 加载进度
                this.loadingManager.onProgress = (url, loaded, total) => {
                    const progress = (loaded / total * 100).toFixed(2);
                    document.getElementById('info').textContent = `加载模型中: ${progress}%`;
                };

                // 加载完成
                this.loadingManager.onLoad = () => {
                    document.getElementById('info').textContent = '模型加载完成，点击启动AR';
                    document.getElementById('startAR').disabled = false;
                };

                // 加载错误
                this.loadingManager.onError = (url) => {
                    console.error('模型加载失败:', url);
                    document.getElementById('info').textContent = '模型加载失败，请检查文件路径';
                };
            }

            async initAR() {
                // 检查 WebXR 支持
                if ('xr' in navigator) {
                    try {
                        const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
                        const startButton = document.getElementById('startAR');
                        const infoDiv = document.getElementById('info');

                        if (isSupported) {
                            startButton.disabled = false;
                            infoDiv.textContent = '设备支持 AR，点击按钮开始';
                        } else {
                            infoDiv.textContent = '设备不支持 AR';
                        }
                    } catch (error) {
                        console.error('AR 检查失败:', error);
                        document.getElementById('info').textContent = 'AR 检查失败: ' + error.message;
                    }
                } else {
                    document.getElementById('info').textContent = '浏览器不支持 WebXR';
                }
            }

            initScene() {
                // 添加光
                const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
                light.position.set(0.5, 1, 0.25);
                this.scene.add(light);

                // 创建瞄准器
                this.reticle = new THREE.Mesh(
                    new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
                    new THREE.MeshBasicMaterial()
                );
                this.reticle.matrixAutoUpdate = false;
                this.reticle.visible = false;
                this.scene.add(this.reticle);

                // 添加控制器
                this.controller = this.renderer.xr.getController(0);
                this.controller.addEventListener('select', () => this.onSelect());
                this.scene.add(this.controller);
            }

            setupEventListeners() {
                window.addEventListener('resize', () => this.onWindowResize());
                
                document.getElementById('startAR').addEventListener('click', async () => {
                    try {
                        const session = await navigator.xr.requestSession('immersive-ar', {
                            requiredFeatures: ['hit-test'],
                            optionalFeatures: ['dom-overlay'],
                            domOverlay: { root: document.querySelector('.ui-container') }
                        });

                        this.renderer.xr.setSession(session);
                        document.getElementById('startAR').style.display = 'none';
                        document.getElementById('info').textContent = '点击屏幕放置物体';
                        
                        session.addEventListener('end', () => {
                            document.getElementById('startAR').style.display = 'block';
                            document.getElementById('info').textContent = 'AR 会话已结束';
                        });
                    } catch (error) {
                        console.error('AR 启动失败:', error);
                        document.getElementById('info').textContent = 'AR 启动失败: ' + error.message;
                    }
                });
            }

            onSelect() {
                if (this.reticle.visible && this.model) {
                    // 克隆模型
                    const modelClone = this.model.clone();
                    
                    // 获取瞄准点的位置和方向
                    const position = new THREE.Vector3();
                    const rotation = new THREE.Quaternion();
                    const scale = new THREE.Vector3();
                    this.reticle.matrix.decompose(position, rotation, scale);

                    // 设置模型位置
                    modelClone.position.copy(position);
                    modelClone.quaternion.copy(rotation);
                    
                    // 添加到场景
                    this.scene.add(modelClone);

                    // 如果有动画，设置动画
                    if (this.model.animations && this.model.animations.length > 0) {
                        const mixer = new THREE.AnimationMixer(modelClone);
                        this.model.animations.forEach((clip) => {
                            mixer.clipAction(clip).play();
                        });
                        this.mixers.push(mixer);
                    }

                    // 更新提示信息
                    document.getElementById('info').textContent = '模型已放置，可继续点击放置更多';
                }
            }

            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            animate() {
                this.renderer.setAnimationLoop((timestamp, frame) => this.render(timestamp, frame));
            }

            render(timestamp, frame) {
                // 更新动画
                if (this.mixers.length > 0) {
                    const delta = this.clock.getDelta();
                    this.mixers.forEach(mixer => mixer.update(delta));
                }

                if (frame) {
                    const referenceSpace = this.renderer.xr.getReferenceSpace();
                    const session = this.renderer.xr.getSession();

                    if (this.hitTestSourceRequested === false) {
                        session.requestReferenceSpace('viewer').then((referenceSpace) => {
                            session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                                this.hitTestSource = source;
                            });
                        });
                        this.hitTestSourceRequested = true;
                    }

                    if (this.hitTestSource) {
                        const hitTestResults = frame.getHitTestResults(this.hitTestSource);
                        if (hitTestResults.length) {
                            const hit = hitTestResults[0];
                            this.reticle.visible = true;
                            this.reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                        } else {
                            this.reticle.visible = false;
                        }
                    }
                }

                this.renderer.render(this.scene, this.camera);
            }

            async loadModel() {
                try {
                    document.getElementById('info').textContent = '开始加载模型...';
                    
                    const gltf = await this.gltfLoader.loadAsync(this.modelPath);
                    this.model = gltf.scene;

                    // 调整模型
                    this.model.scale.set(this.modelScale, this.modelScale, this.modelScale);
                    
                    // 处理模型材质和阴影
                    this.model.traverse((node) => {
                        if (node.isMesh) {
                            node.castShadow = true;
                            node.receiveShadow = true;
                            // 确保材质正确显示
                            if (node.material) {
                                node.material.side = THREE.DoubleSide;
                            }
                        }
                    });

                    // 如果模型有动画，设置动画
                    if (gltf.animations && gltf.animations.length > 0) {
                        const mixer = new THREE.AnimationMixer(this.model);
                        gltf.animations.forEach((clip) => {
                            mixer.clipAction(clip).play();
                        });
                        this.mixers.push(mixer);
                    }

                    console.log('模型加载成功');
                } catch (error) {
                    console.error('模型加载错误:', error);
                    document.getElementById('info').textContent = '模型加载失败: ' + error.message;
                }
            }
        }

        // 创建实例
        const ar = new WebXRAR();
        ar.animate();
    </script>
</body>
</html> 